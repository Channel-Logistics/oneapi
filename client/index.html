<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>SSE demo</title>
    <style>
      body { font-family: system-ui, sans-serif; max-width: 760px; margin: 2rem auto; }
      .log { white-space: pre-wrap; background: #111; color: #e5e5e5; padding: 1rem; border-radius: 8px; min-height: 200px; }
      button { padding: .6rem 1rem; }
    </style>
  </head>
  <body>
    <h1>Satellite Task SSE</h1>
    <button id="start">Create task</button>
    <div id="status"></div>
    <div class="log" id="log"></div>
    <script>
      const log = (t) => document.getElementById('log').textContent += t + "\n";

      document.getElementById('start').onclick = async () => {
        const res = await fetch('http://localhost:8000/tasks', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({
          "type": "serch",
          "start_date": "2024-01-01T00:00:00Z",
          "end_date": "2024-02-01T00:00:00Z",
          "bbox": [-122.5, 37.5, -122.0, 38.0]
        }) });
        const j = await res.json();
        document.getElementById('status').textContent = `Task: ${j.taskId}`;
        const es = new EventSource(`http://localhost:8000${j.sseUrl}`);
        es.addEventListener('task.started', e => {
          const data = JSON.parse(e.data);
          document.getElementById('status').textContent = `Task ${data.taskId} picked up by worker`;
          log(`[started] ${e.data}`);
        });
        es.addEventListener('provider.update', e => log(`[provider] ${e.data}`));
        es.addEventListener('task.complete', e => { log(`[done] ${e.data}`); es.close(); });
        es.addEventListener('task.failed', e => {
          const data = JSON.parse(e.data);
          document.getElementById('status').textContent = `âŒ Task ${data.taskId} failed: ${data.error}`;
          log(`[failed] ${e.data}`);
          es.close();
        });
        es.onerror = () => log('SSE connection error');
      };
    </script>
  </body>
</html>
